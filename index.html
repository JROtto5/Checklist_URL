<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ARMOR Checklist Dashboard</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --primary: #6366f1;
    --primary-dark: #4f46e5;
    --accent: #8b5cf6;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
    --dark: #0f172a;
    --darker: #020617;
  }

  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--darker);
    color: #e2e8f0;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Animated gradient background */
  .bg-animate {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(-45deg, #0f172a, #1e1b4b, #172554, #0c4a6e, #134e4a);
    background-size: 400% 400%;
    animation: gradientBG 15s ease infinite;
    z-index: -2;
  }

  @keyframes gradientBG {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }

  /* Floating particles */
  .particles {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: -1;
    overflow: hidden;
  }

  .particle {
    position: absolute;
    width: 6px;
    height: 6px;
    background: rgba(99, 102, 241, 0.3);
    border-radius: 50%;
    animation: float 20s infinite;
  }

  @keyframes float {
    0%, 100% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
    10% { opacity: 1; }
    90% { opacity: 1; }
    100% { transform: translateY(-100vh) rotate(720deg); opacity: 0; }
  }

  /* Animations */
  @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
  @keyframes glow { 0%, 100% { box-shadow: 0 0 20px rgba(99, 102, 241, 0.5); } 50% { box-shadow: 0 0 40px rgba(99, 102, 241, 0.8), 0 0 60px rgba(139, 92, 246, 0.4); } }
  @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
  @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
  @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
  @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  @keyframes countUp { from { opacity: 0; transform: scale(0.5); } to { opacity: 1; transform: scale(1); } }
  @keyframes borderGlow { 0%, 100% { border-color: rgba(99, 102, 241, 0.5); } 50% { border-color: rgba(139, 92, 246, 0.8); } }

  .fade-in-up { animation: fadeInUp 0.5s ease-out forwards; }
  .fade-in { animation: fadeIn 0.3s ease-out; }

  /* Glassmorphism */
  .glass {
    background: rgba(15, 23, 42, 0.7);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .glass-light {
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  /* Top bar */
  .topbar {
    background: rgba(15, 23, 42, 0.8);
    backdrop-filter: blur(20px);
    padding: 16px 28px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    position: sticky;
    top: 0;
    z-index: 50;
  }

  .topbar-left { display: flex; align-items: center; gap: 20px; }

  .logo {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .logo-icon {
    width: 44px;
    height: 44px;
    background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    font-weight: 900;
    color: #fff;
    animation: glow 3s ease-in-out infinite;
    box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);
  }

  .logo-text {
    font-size: 26px;
    font-weight: 900;
    background: linear-gradient(135deg, #fff 0%, #a5b4fc 50%, #c4b5fd 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    letter-spacing: -1px;
  }

  .topbar-sub {
    font-size: 13px;
    color: #64748b;
    padding-left: 20px;
    border-left: 2px solid rgba(99, 102, 241, 0.3);
    font-weight: 500;
  }

  .topbar-actions { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }

  .topbar-btn {
    padding: 10px 18px;
    background: rgba(255, 255, 255, 0.05);
    color: #cbd5e1;
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    font-size: 13px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .topbar-btn:hover {
    background: rgba(255, 255, 255, 0.1);
    border-color: rgba(99, 102, 241, 0.5);
    transform: translateY(-2px);
    box-shadow: 0 4px 20px rgba(99, 102, 241, 0.2);
  }

  .topbar-btn.primary {
    background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
    border: none;
    color: #fff;
  }

  .topbar-btn.primary:hover {
    box-shadow: 0 4px 25px rgba(99, 102, 241, 0.5);
    transform: translateY(-2px) scale(1.02);
  }

  .topbar-btn label { cursor: pointer; display: flex; align-items: center; gap: 8px; }
  .topbar-btn input[type=file] { display: none; }

  /* Sync status with glow */
  .sync-indicator {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 16px;
    border-radius: 25px;
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    transition: all 0.3s;
  }

  .sync-connected {
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(52, 211, 153, 0.2) 100%);
    color: #34d399;
    border: 1px solid rgba(16, 185, 129, 0.3);
    box-shadow: 0 0 20px rgba(16, 185, 129, 0.2);
  }

  .sync-local {
    background: linear-gradient(135deg, rgba(245, 158, 11, 0.2) 0%, rgba(251, 191, 36, 0.2) 100%);
    color: #fbbf24;
    border: 1px solid rgba(245, 158, 11, 0.3);
  }

  .sync-error {
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.2) 0%, rgba(248, 113, 113, 0.2) 100%);
    color: #f87171;
    border: 1px solid rgba(239, 68, 68, 0.3);
  }

  .sync-loading {
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.2) 0%, rgba(139, 92, 246, 0.2) 100%);
    color: #a5b4fc;
    border: 1px solid rgba(99, 102, 241, 0.3);
  }

  .sync-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: currentColor;
    box-shadow: 0 0 10px currentColor;
  }

  .sync-loading .sync-dot { animation: pulse 1s infinite; }
  .sync-connected .sync-dot { animation: pulse 2s infinite; }

  /* Stats with animated counters */
  .stats {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 20px;
    padding: 28px;
  }

  .stat-card {
    padding: 24px;
    border-radius: 20px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
    animation: fadeInUp 0.5s ease-out backwards;
  }

  .stat-card:nth-child(1) { animation-delay: 0.1s; }
  .stat-card:nth-child(2) { animation-delay: 0.15s; }
  .stat-card:nth-child(3) { animation-delay: 0.2s; }
  .stat-card:nth-child(4) { animation-delay: 0.25s; }
  .stat-card:nth-child(5) { animation-delay: 0.3s; }
  .stat-card:nth-child(6) { animation-delay: 0.35s; }

  .stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
    transition: left 0.5s;
  }

  .stat-card:hover::before { left: 100%; }

  .stat-card:hover {
    transform: translateY(-8px) scale(1.02);
    border-color: rgba(99, 102, 241, 0.5);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3), 0 0 30px rgba(99, 102, 241, 0.2);
  }

  .stat-label {
    font-size: 11px;
    color: #64748b;
    text-transform: uppercase;
    letter-spacing: 1px;
    font-weight: 700;
    margin-bottom: 8px;
  }

  .stat-value {
    font-size: 36px;
    font-weight: 900;
    background: linear-gradient(135deg, #fff 0%, #94a3b8 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .stat-card.green { background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(5, 150, 105, 0.1) 100%); }
  .stat-card.green .stat-value { background: linear-gradient(135deg, #34d399 0%, #10b981 100%); -webkit-background-clip: text; background-clip: text; }
  .stat-card.red { background: linear-gradient(135deg, rgba(239, 68, 68, 0.15) 0%, rgba(220, 38, 38, 0.1) 100%); }
  .stat-card.red .stat-value { background: linear-gradient(135deg, #f87171 0%, #ef4444 100%); -webkit-background-clip: text; background-clip: text; }
  .stat-card.yellow { background: linear-gradient(135deg, rgba(245, 158, 11, 0.15) 0%, rgba(217, 119, 6, 0.1) 100%); }
  .stat-card.yellow .stat-value { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); -webkit-background-clip: text; background-clip: text; }
  .stat-card.purple { background: linear-gradient(135deg, rgba(139, 92, 246, 0.15) 0%, rgba(124, 58, 237, 0.1) 100%); }
  .stat-card.purple .stat-value { background: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%); -webkit-background-clip: text; background-clip: text; }

  /* Filters */
  .filters {
    display: flex;
    gap: 16px;
    padding: 0 28px 24px;
    align-items: center;
    flex-wrap: wrap;
  }

  .filter-input {
    flex: 1;
    min-width: 280px;
    padding: 14px 20px;
    border-radius: 14px;
    border: 2px solid rgba(255, 255, 255, 0.1);
    font-size: 14px;
    transition: all 0.3s;
    background: rgba(255, 255, 255, 0.05);
    color: #e2e8f0;
  }

  .filter-input::placeholder { color: #64748b; }

  .filter-input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 30px rgba(99, 102, 241, 0.3);
    background: rgba(255, 255, 255, 0.08);
  }

  .filter-select {
    padding: 14px 20px;
    border-radius: 14px;
    border: 2px solid rgba(255, 255, 255, 0.1);
    font-size: 14px;
    background: rgba(255, 255, 255, 0.05);
    color: #e2e8f0;
    cursor: pointer;
    transition: all 0.3s;
  }

  .filter-select:focus {
    outline: none;
    border-color: var(--primary);
  }

  .filter-select option { background: var(--dark); }

  .filter-count {
    font-size: 13px;
    color: #94a3b8;
    font-weight: 600;
    background: rgba(99, 102, 241, 0.2);
    padding: 10px 20px;
    border-radius: 25px;
    border: 1px solid rgba(99, 102, 241, 0.3);
  }

  /* Table */
  .table-wrap { padding: 0 28px 28px; }

  .table-container {
    background: rgba(15, 23, 42, 0.6);
    backdrop-filter: blur(20px);
    border-radius: 20px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    overflow: hidden;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    animation: fadeInUp 0.6s ease-out backwards;
    animation-delay: 0.4s;
  }

  table { width: 100%; border-collapse: collapse; font-size: 14px; }

  thead tr {
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }

  th {
    padding: 18px 20px;
    text-align: left;
    font-weight: 700;
    color: #a5b4fc;
    cursor: pointer;
    user-select: none;
    white-space: nowrap;
    transition: all 0.3s;
    text-transform: uppercase;
    font-size: 11px;
    letter-spacing: 1px;
  }

  th:hover { color: #fff; background: rgba(99, 102, 241, 0.2); }
  td { padding: 18px 20px; }

  tbody tr {
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    cursor: pointer;
    transition: all 0.3s;
  }

  tbody tr:hover {
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
    transform: scale(1.01);
  }

  tbody tr.selected {
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.2) 0%, rgba(139, 92, 246, 0.2) 100%);
    border-left: 3px solid var(--primary);
  }

  .empty-row td {
    padding: 80px;
    text-align: center;
    color: #64748b;
    cursor: default;
    font-size: 16px;
  }

  /* Badges with glow */
  .badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 9999px;
    font-size: 10px;
    font-weight: 800;
    margin-right: 6px;
    margin-bottom: 4px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    transition: all 0.3s;
  }

  .badge:hover { transform: scale(1.1); }

  .badge-good {
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.3) 0%, rgba(52, 211, 153, 0.3) 100%);
    color: #34d399;
    border: 1px solid rgba(16, 185, 129, 0.5);
    box-shadow: 0 0 15px rgba(16, 185, 129, 0.3);
  }

  .badge-bad {
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.3) 0%, rgba(248, 113, 113, 0.3) 100%);
    color: #f87171;
    border: 1px solid rgba(239, 68, 68, 0.5);
    box-shadow: 0 0 15px rgba(239, 68, 68, 0.3);
  }

  .badge-inconclusive {
    background: linear-gradient(135deg, rgba(245, 158, 11, 0.3) 0%, rgba(251, 191, 36, 0.3) 100%);
    color: #fbbf24;
    border: 1px solid rgba(245, 158, 11, 0.5);
    box-shadow: 0 0 15px rgba(245, 158, 11, 0.3);
  }

  .score-badge {
    display: inline-block;
    padding: 8px 20px;
    border-radius: 9999px;
    font-size: 16px;
    font-weight: 900;
  }

  .score-33 {
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.3) 0%, rgba(220, 38, 38, 0.3) 100%);
    color: #f87171;
    border: 1px solid rgba(239, 68, 68, 0.5);
    box-shadow: 0 0 20px rgba(239, 68, 68, 0.3);
  }

  .score-66 {
    background: linear-gradient(135deg, rgba(245, 158, 11, 0.3) 0%, rgba(217, 119, 6, 0.3) 100%);
    color: #fbbf24;
    border: 1px solid rgba(245, 158, 11, 0.5);
    box-shadow: 0 0 20px rgba(245, 158, 11, 0.3);
  }

  .score-100 {
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.3) 0%, rgba(5, 150, 105, 0.3) 100%);
    color: #34d399;
    border: 1px solid rgba(16, 185, 129, 0.5);
    box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
  }

  .status-badge {
    display: inline-block;
    padding: 8px 18px;
    border-radius: 9999px;
    font-size: 11px;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .status-sufficient {
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.3) 0%, rgba(52, 211, 153, 0.3) 100%);
    color: #34d399;
    border: 1px solid rgba(16, 185, 129, 0.5);
  }

  .status-insufficient {
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.3) 0%, rgba(248, 113, 113, 0.3) 100%);
    color: #f87171;
    border: 1px solid rgba(239, 68, 68, 0.5);
  }

  /* Overlay + Detail Panel */
  .overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(8px);
    z-index: 99;
    display: none;
  }

  .overlay.active { display: block; animation: fadeIn 0.3s ease-out; }

  .detail-panel {
    position: fixed;
    top: 0;
    right: 0;
    bottom: 0;
    width: 60%;
    min-width: 550px;
    background: linear-gradient(135deg, rgba(15, 23, 42, 0.95) 0%, rgba(30, 27, 75, 0.95) 100%);
    backdrop-filter: blur(30px);
    border-left: 1px solid rgba(99, 102, 241, 0.3);
    box-shadow: -10px 0 50px rgba(0, 0, 0, 0.5), 0 0 30px rgba(99, 102, 241, 0.1);
    z-index: 100;
    display: none;
    flex-direction: column;
    overflow: hidden;
  }

  .detail-panel.active { display: flex; animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); }

  .detail-header {
    padding: 24px 28px;
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-shrink: 0;
  }

  .detail-header h2 {
    font-size: 22px;
    font-weight: 800;
    margin: 0;
    background: linear-gradient(135deg, #fff 0%, #a5b4fc 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .detail-header p { margin: 6px 0 0; font-size: 14px; color: #64748b; }

  .detail-close {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.1);
    font-size: 14px;
    cursor: pointer;
    color: #94a3b8;
    padding: 10px 18px;
    border-radius: 10px;
    transition: all 0.3s;
    font-weight: 600;
  }

  .detail-close:hover {
    background: rgba(239, 68, 68, 0.2);
    border-color: rgba(239, 68, 68, 0.5);
    color: #f87171;
  }

  .detail-body { flex: 1; overflow-y: auto; padding: 28px; }

  /* Detail sections */
  .detail-row { display: flex; gap: 20px; margin-bottom: 24px; }

  .detail-card {
    flex: 1;
    padding: 20px;
    background: rgba(255, 255, 255, 0.03);
    border-radius: 16px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: all 0.3s;
  }

  .detail-card:hover {
    border-color: rgba(99, 102, 241, 0.3);
    box-shadow: 0 0 20px rgba(99, 102, 241, 0.1);
  }

  .detail-card-label {
    font-size: 10px;
    color: #64748b;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 10px;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .detail-card p { margin: 0; font-size: 14px; color: #cbd5e1; line-height: 1.6; }
  .detail-card .mono { font-family: 'SF Mono', Monaco, monospace; font-size: 15px; color: #a5b4fc; }

  .summary-card {
    padding: 24px;
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
    border-radius: 16px;
    border: 1px solid rgba(99, 102, 241, 0.2);
    margin-bottom: 24px;
  }

  .summary-card p.main { font-size: 16px; font-weight: 600; color: #e2e8f0; line-height: 1.6; }
  .summary-notes { margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255, 255, 255, 0.1); }
  .summary-notes p { margin: 8px 0; font-size: 13px; color: #94a3b8; line-height: 1.6; }

  /* Copy button */
  .copy-btn {
    background: rgba(99, 102, 241, 0.2);
    border: 1px solid rgba(99, 102, 241, 0.3);
    color: #a5b4fc;
    font-size: 10px;
    cursor: pointer;
    padding: 4px 10px;
    border-radius: 6px;
    font-weight: 700;
    transition: all 0.3s;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .copy-btn:hover {
    background: rgba(99, 102, 241, 0.3);
    transform: scale(1.05);
  }

  .copy-btn.copied {
    background: rgba(16, 185, 129, 0.3);
    border-color: rgba(16, 185, 129, 0.5);
    color: #34d399;
  }

  /* Indicator cards */
  .indicators-section { margin-bottom: 24px; }

  .indicators-section h3 {
    font-size: 14px;
    margin-bottom: 16px;
    font-weight: 700;
    color: #a5b4fc;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .indicator-card {
    border-radius: 16px;
    margin-bottom: 12px;
    overflow: hidden;
    transition: all 0.3s;
  }

  .indicator-card:hover { transform: translateX(8px); }

  .indicator-card.good {
    border: 1px solid rgba(16, 185, 129, 0.3);
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(52, 211, 153, 0.05) 100%);
  }

  .indicator-card.bad {
    border: 1px solid rgba(239, 68, 68, 0.3);
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(248, 113, 113, 0.05) 100%);
  }

  .indicator-card.inconclusive {
    border: 1px solid rgba(245, 158, 11, 0.3);
    background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(251, 191, 36, 0.05) 100%);
  }

  .indicator-toggle {
    width: 100%;
    padding: 18px 20px;
    background: none;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
    text-align: left;
  }

  .indicator-toggle .left { display: flex; align-items: center; gap: 12px; }
  .indicator-toggle .label { font-size: 14px; color: #cbd5e1; font-weight: 500; }
  .indicator-toggle .arrow { font-size: 12px; color: #64748b; transition: transform 0.3s; }
  .indicator-toggle .arrow.open { transform: rotate(180deg); }
  .indicator-detail { padding: 0 20px 20px; font-size: 14px; line-height: 1.7; display: none; }
  .indicator-detail.open { display: block; animation: fadeIn 0.3s ease-out; }
  .indicator-detail strong { color: #a5b4fc; }
  .indicator-detail p { margin: 8px 0; color: #94a3b8; }

  .customer-msg {
    padding: 16px;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    margin-top: 12px;
  }

  .customer-msg strong { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: #64748b; }
  .customer-msg p { font-size: 13px; margin: 8px 0 0; color: #94a3b8; }

  /* Clarification */
  .clarification-section {
    padding: 24px;
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
    border-radius: 16px;
    border: 1px solid rgba(99, 102, 241, 0.2);
    margin-bottom: 24px;
  }

  .clarification-section .label {
    font-size: 10px;
    color: #a5b4fc;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 12px;
    font-weight: 700;
  }

  .clarification-explainer {
    font-size: 13px;
    color: #94a3b8;
    margin-bottom: 16px;
    line-height: 1.6;
    padding: 12px 16px;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 10px;
    border-left: 3px solid var(--primary);
  }

  .clarification-entry {
    background: rgba(0, 0, 0, 0.3);
    border-radius: 12px;
    border: 1px solid rgba(99, 102, 241, 0.2);
    padding: 16px;
    margin-bottom: 12px;
    transition: all 0.3s;
  }

  .clarification-entry:hover {
    border-color: rgba(99, 102, 241, 0.4);
    box-shadow: 0 0 15px rgba(99, 102, 241, 0.1);
  }

  .clarification-entry-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
  }

  .clarification-date {
    font-size: 11px;
    color: #64748b;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .clarification-edited-tag {
    font-size: 10px;
    color: #94a3b8;
    font-style: italic;
    margin-left: 8px;
    font-weight: 400;
  }

  .clarification-entry-text {
    font-size: 14px;
    color: #e2e8f0;
    white-space: pre-wrap;
    line-height: 1.6;
  }

  .clarification-action-btn {
    background: none;
    border: none;
    color: #64748b;
    font-size: 12px;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 6px;
    transition: all 0.3s;
    margin-left: 4px;
  }

  .clarification-action-btn:hover { background: rgba(255, 255, 255, 0.1); color: #a5b4fc; }
  .clarification-action-btn.delete:hover { color: #f87171; }

  .clarification-collapse-btn {
    background: rgba(99, 102, 241, 0.2);
    border: 1px solid rgba(99, 102, 241, 0.3);
    color: #a5b4fc;
    font-size: 12px;
    cursor: pointer;
    padding: 10px 20px;
    border-radius: 10px;
    margin-bottom: 12px;
    width: 100%;
    text-align: center;
    font-weight: 600;
    transition: all 0.3s;
  }

  .clarification-collapse-btn:hover {
    background: rgba(99, 102, 241, 0.3);
  }

  .clarification-section textarea {
    width: 100%;
    min-height: 100px;
    padding: 16px;
    border-radius: 12px;
    border: 2px solid rgba(99, 102, 241, 0.2);
    font-size: 14px;
    font-family: inherit;
    resize: vertical;
    transition: all 0.3s;
    background: rgba(0, 0, 0, 0.2);
    color: #e2e8f0;
  }

  .clarification-section textarea::placeholder { color: #64748b; }

  .clarification-section textarea:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 30px rgba(99, 102, 241, 0.2);
  }

  .save-row { display: flex; align-items: center; gap: 16px; margin-top: 16px; }

  .save-btn {
    padding: 12px 28px;
    background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
    color: #fff;
    border: none;
    border-radius: 12px;
    font-size: 14px;
    cursor: pointer;
    font-weight: 700;
    transition: all 0.3s;
  }

  .save-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 30px rgba(99, 102, 241, 0.4);
  }

  .save-confirm { font-size: 14px; color: #34d399; font-weight: 700; }

  /* Reanalysis section */
  .reanalysis-section {
    padding: 24px;
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(52, 211, 153, 0.05) 100%);
    border-radius: 16px;
    border: 1px solid rgba(16, 185, 129, 0.2);
    margin-bottom: 24px;
  }

  /* Override section */
  .override-section {
    padding: 24px;
    background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(124, 58, 237, 0.05) 100%);
    border-radius: 16px;
    border: 1px solid rgba(139, 92, 246, 0.2);
    margin-bottom: 24px;
  }

  /* Q&A Section */
  .qa-section {
    padding: 24px;
    background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(217, 119, 6, 0.05) 100%);
    border-radius: 16px;
    border: 1px solid rgba(245, 158, 11, 0.2);
    margin-bottom: 24px;
  }

  .qa-section .qa-header {
    font-size: 10px;
    color: #fbbf24;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 16px;
    font-weight: 700;
  }

  .qa-item {
    padding: 16px;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 12px;
    border: 1px solid rgba(245, 158, 11, 0.2);
    margin-bottom: 10px;
  }

  .qa-item .qa-q { font-size: 12px; color: #fbbf24; font-weight: 700; margin-bottom: 8px; }
  .qa-item .qa-a { font-size: 14px; color: #cbd5e1; white-space: pre-wrap; line-height: 1.6; }
  .qa-loading { font-size: 14px; color: #fbbf24; font-style: italic; }
  .qa-unavailable { font-size: 14px; color: #64748b; font-style: italic; }

  /* Modals */
  .modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(10px);
    z-index: 200;
    display: none;
    justify-content: center;
    align-items: center;
  }

  .modal.active { display: flex; animation: fadeIn 0.3s ease-out; }

  .modal-box {
    background: linear-gradient(135deg, rgba(15, 23, 42, 0.98) 0%, rgba(30, 27, 75, 0.98) 100%);
    border-radius: 24px;
    padding: 36px;
    width: 620px;
    max-height: 85vh;
    overflow-y: auto;
    border: 1px solid rgba(99, 102, 241, 0.3);
    box-shadow: 0 30px 60px rgba(0, 0, 0, 0.5), 0 0 40px rgba(99, 102, 241, 0.2);
    animation: fadeInUp 0.4s ease-out;
  }

  .modal-box h3 {
    font-size: 24px;
    font-weight: 800;
    margin-bottom: 10px;
    background: linear-gradient(135deg, #fff 0%, #a5b4fc 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .modal-box > p { font-size: 14px; color: #64748b; margin-bottom: 24px; line-height: 1.6; }

  .modal-box textarea {
    width: 100%;
    min-height: 250px;
    padding: 16px;
    border: 2px solid rgba(255, 255, 255, 0.1);
    border-radius: 14px;
    font-family: 'SF Mono', Monaco, monospace;
    font-size: 13px;
    resize: vertical;
    transition: all 0.3s;
    background: rgba(0, 0, 0, 0.3);
    color: #e2e8f0;
  }

  .modal-box textarea:focus { outline: none; border-color: var(--primary); }

  .modal-box input[type=text] {
    width: 100%;
    padding: 14px 18px;
    border: 2px solid rgba(255, 255, 255, 0.1);
    border-radius: 14px;
    font-family: 'SF Mono', Monaco, monospace;
    font-size: 13px;
    margin-bottom: 20px;
    transition: all 0.3s;
    background: rgba(0, 0, 0, 0.3);
    color: #e2e8f0;
  }

  .modal-box input[type=text]:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 30px rgba(99, 102, 241, 0.2);
  }

  .modal-actions { display: flex; gap: 12px; margin-top: 28px; justify-content: flex-end; }

  .btn-primary {
    padding: 14px 32px;
    background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
    color: #fff;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    font-weight: 700;
    font-size: 14px;
    transition: all 0.3s;
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 30px rgba(99, 102, 241, 0.4);
  }

  .btn-secondary {
    padding: 14px 28px;
    background: rgba(255, 255, 255, 0.05);
    color: #94a3b8;
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
    transition: all 0.3s;
  }

  .btn-secondary:hover { background: rgba(255, 255, 255, 0.1); color: #fff; }

  /* Help Modal */
  .help-modal .modal-box { width: 700px; }

  .help-section { margin-bottom: 28px; }

  .help-section h4 {
    font-size: 15px;
    font-weight: 700;
    color: #e2e8f0;
    margin-bottom: 14px;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .help-section h4 .step-num {
    background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
    color: #fff;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 13px;
    box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
  }

  .help-section p { font-size: 14px; color: #94a3b8; line-height: 1.7; margin-bottom: 10px; }

  .help-section .code-block {
    background: rgba(0, 0, 0, 0.4);
    color: #a5b4fc;
    padding: 16px 20px;
    border-radius: 12px;
    font-family: 'SF Mono', Monaco, monospace;
    font-size: 11px;
    overflow-x: auto;
    margin: 14px 0;
    word-break: break-all;
    border: 1px solid rgba(99, 102, 241, 0.2);
  }

  .help-tip {
    background: linear-gradient(135deg, rgba(245, 158, 11, 0.15) 0%, rgba(217, 119, 6, 0.1) 100%);
    border: 1px solid rgba(245, 158, 11, 0.3);
    border-radius: 14px;
    padding: 18px 20px;
    margin: 20px 0;
  }

  .help-tip strong { color: #fbbf24; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; }
  .help-tip p { color: #fcd34d; margin: 8px 0 0; font-size: 13px; }

  .help-warning {
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.15) 0%, rgba(220, 38, 38, 0.1) 100%);
    border: 1px solid rgba(239, 68, 68, 0.3);
    border-radius: 14px;
    padding: 18px 20px;
    margin: 20px 0;
  }

  .help-warning strong { color: #f87171; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; }
  .help-warning p { color: #fca5a5; margin: 8px 0 0; font-size: 13px; }

  .help-list { list-style: none; padding: 0; margin: 14px 0; }

  .help-list li {
    padding: 10px 0 10px 32px;
    position: relative;
    font-size: 14px;
    color: #94a3b8;
  }

  .help-list li::before {
    content: '';
    position: absolute;
    left: 0;
    top: 16px;
    width: 10px;
    height: 10px;
    background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
    border-radius: 50%;
    box-shadow: 0 0 10px rgba(99, 102, 241, 0.5);
  }

  /* PIN Lock Screen */
  .lock-screen {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--darker);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
  }

  .lock-screen .bg-animate { z-index: 0; }
  .lock-screen .particles { z-index: 1; }

  .lock-screen.hidden { display: none; }

  .lock-box {
    background: rgba(15, 23, 42, 0.8);
    backdrop-filter: blur(30px);
    border-radius: 32px;
    padding: 56px 48px;
    width: 420px;
    text-align: center;
    border: 1px solid rgba(99, 102, 241, 0.3);
    box-shadow: 0 30px 60px rgba(0, 0, 0, 0.5), 0 0 50px rgba(99, 102, 241, 0.2);
    position: relative;
    z-index: 2;
    animation: fadeInUp 0.6s ease-out;
  }

  .lock-box .lock-logo {
    width: 80px;
    height: 80px;
    background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
    border-radius: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 32px;
    font-weight: 900;
    color: #fff;
    margin: 0 auto 24px;
    animation: glow 3s ease-in-out infinite;
    box-shadow: 0 10px 40px rgba(99, 102, 241, 0.5);
  }

  .lock-box h1 {
    font-size: 36px;
    font-weight: 900;
    margin-bottom: 8px;
    background: linear-gradient(135deg, #fff 0%, #a5b4fc 50%, #c4b5fd 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    letter-spacing: -1px;
  }

  .lock-box .subtitle { font-size: 14px; color: #64748b; margin-bottom: 36px; }

  .lock-box input {
    width: 100%;
    padding: 18px;
    border-radius: 16px;
    border: 2px solid rgba(99, 102, 241, 0.3);
    background: rgba(0, 0, 0, 0.3);
    color: #fff;
    font-size: 28px;
    text-align: center;
    letter-spacing: 16px;
    font-family: 'SF Mono', Monaco, monospace;
    outline: none;
    transition: all 0.3s;
  }

  .lock-box input:focus {
    border-color: var(--primary);
    box-shadow: 0 0 40px rgba(99, 102, 241, 0.3);
  }

  .lock-box input::placeholder { letter-spacing: 10px; font-size: 22px; color: #475569; }

  .lock-box button {
    width: 100%;
    padding: 18px;
    background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
    color: #fff;
    border: none;
    border-radius: 16px;
    font-size: 18px;
    font-weight: 800;
    cursor: pointer;
    margin-top: 24px;
    transition: all 0.3s;
    text-transform: uppercase;
    letter-spacing: 2px;
  }

  .lock-box button:hover {
    transform: translateY(-3px);
    box-shadow: 0 15px 40px rgba(99, 102, 241, 0.5);
  }

  .lock-error { color: #f87171; font-size: 14px; margin-top: 20px; min-height: 24px; font-weight: 600; }

  .app-content { display: none; }
  .app-content.unlocked { display: block; }

  /* Config modal */
  .config-status {
    font-size: 14px;
    color: #94a3b8;
    margin-bottom: 20px;
    padding: 16px;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .config-status strong { color: #a5b4fc; }

  .auto-sync-row {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 20px;
    padding: 16px;
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
    border-radius: 14px;
    border: 1px solid rgba(99, 102, 241, 0.2);
  }

  .auto-sync-row label { font-size: 14px; color: #a5b4fc; font-weight: 600; flex: 1; }

  .toggle-switch { position: relative; width: 56px; height: 30px; }
  .toggle-switch input { opacity: 0; width: 0; height: 0; }

  .toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 30px;
    transition: 0.4s;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .toggle-slider::before {
    position: absolute;
    content: '';
    height: 22px;
    width: 22px;
    left: 3px;
    bottom: 3px;
    background: #fff;
    border-radius: 50%;
    transition: 0.4s;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
  }

  .toggle-switch input:checked + .toggle-slider {
    background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
    box-shadow: 0 0 20px rgba(99, 102, 241, 0.4);
  }

  .toggle-switch input:checked + .toggle-slider::before { transform: translateX(26px); }

  /* Footer */
  .footer {
    text-align: center;
    padding: 28px;
    color: #475569;
    font-size: 13px;
    border-top: 1px solid rgba(255, 255, 255, 0.05);
  }

  .footer a { color: #6366f1; text-decoration: none; font-weight: 600; transition: all 0.3s; }
  .footer a:hover { color: #a5b4fc; text-shadow: 0 0 10px rgba(99, 102, 241, 0.5); }

  .footer .powered {
    margin-top: 8px;
    font-size: 11px;
    color: #334155;
    text-transform: uppercase;
    letter-spacing: 2px;
  }

  /* Toast notifications */
  .toast-container {
    position: fixed;
    top: 24px;
    right: 24px;
    z-index: 9999;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .toast {
    padding: 16px 24px;
    border-radius: 14px;
    color: #fff;
    font-weight: 600;
    font-size: 14px;
    animation: fadeInUp 0.4s ease-out;
    display: flex;
    align-items: center;
    gap: 12px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
  }

  .toast.success {
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.9) 0%, rgba(5, 150, 105, 0.9) 100%);
    border: 1px solid rgba(52, 211, 153, 0.5);
  }

  .toast.error {
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.9) 0%, rgba(220, 38, 38, 0.9) 100%);
    border: 1px solid rgba(248, 113, 113, 0.5);
  }

  .toast.info {
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.9) 0%, rgba(139, 92, 246, 0.9) 100%);
    border: 1px solid rgba(165, 180, 252, 0.5);
  }

  /* Keyboard shortcut hints */
  .kbd {
    display: inline-block;
    padding: 2px 8px;
    font-size: 11px;
    font-family: 'SF Mono', Monaco, monospace;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 6px;
    color: #94a3b8;
    margin-left: 8px;
  }

  /* Responsive */
  @media (max-width: 1200px) {
    .stats { grid-template-columns: repeat(3, 1fr); }
  }

  @media (max-width: 768px) {
    .stats { grid-template-columns: repeat(2, 1fr); }
    .topbar { flex-direction: column; gap: 16px; }
    .topbar-actions { flex-wrap: wrap; justify-content: center; }
    .detail-panel { width: 100%; min-width: unset; }
    .modal-box { width: 95%; margin: 20px; padding: 24px; }
  }
</style>
</head>
<body>

<!-- Animated Background -->
<div class="bg-animate"></div>

<!-- Floating Particles -->
<div class="particles" id="particles"></div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<!-- PIN Lock Screen -->
<div class="lock-screen" id="lockScreen">
  <div class="bg-animate"></div>
  <div class="particles" id="lockParticles"></div>
  <div class="lock-box">
    <div class="lock-logo">A</div>
    <h1>ARMOR</h1>
    <p class="subtitle">Checklist Analyzer Dashboard</p>
    <input type="password" id="pinInput" maxlength="10" placeholder="PIN" onkeydown="if(event.key==='Enter')checkPin()">
    <button onclick="checkPin()">Unlock</button>
    <div class="lock-error" id="pinError"></div>
  </div>
</div>

<!-- App Content -->
<div class="app-content" id="appContent">

<!-- Top Bar -->
<div class="topbar glass">
  <div class="topbar-left">
    <div class="logo">
      <div class="logo-icon">A</div>
      <span class="logo-text">ARMOR</span>
    </div>
    <span class="topbar-sub">Checklist Analyzer Dashboard v4.0</span>
  </div>
  <div class="topbar-actions">
    <span id="syncStatus" class="sync-indicator sync-local"><span class="sync-dot"></span> Local Only</span>
    <button class="topbar-btn" onclick="document.getElementById('helpModal').classList.add('active')">? Help <span class="kbd">H</span></button>
    <button class="topbar-btn" onclick="document.getElementById('pasteModal').classList.add('active')">Paste JSON</button>
    <button class="topbar-btn"><label>Import<input type="file" accept=".json,.jsonl" onchange="handleFileImport(event)"></label></button>
    <button class="topbar-btn" onclick="exportJsonl()">Export JSONL</button>
    <button class="topbar-btn" onclick="exportJson()">Export JSON</button>
    <button class="topbar-btn" onclick="manualSync()">Refresh <span class="kbd">R</span></button>
    <button class="topbar-btn primary" onclick="document.getElementById('configModal').classList.add('active')">Sync Settings</button>
  </div>
</div>

<!-- Stats -->
<div class="stats" id="statsRow"></div>

<!-- Filters -->
<div class="filters">
  <input class="filter-input" type="text" id="searchInput" placeholder="Search company, email, or user ID... (Press / to focus)" oninput="renderTable()">
  <select class="filter-select" id="scoreFilter" onchange="renderTable()">
    <option value="all">All Scores</option>
    <option value="33">Score 33</option>
    <option value="66">Score 66</option>
    <option value="100">Score 100</option>
  </select>
  <select class="filter-select" id="statusFilter" onchange="renderTable()">
    <option value="all">All Statuses</option>
    <option value="Sufficient">Sufficient</option>
    <option value="Insufficient">Insufficient</option>
  </select>
  <span class="filter-count" id="filterCount"></span>
</div>

<!-- Table -->
<div class="table-wrap">
  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th onclick="toggleSort('company')">Company<span id="sort_company"></span></th>
          <th onclick="toggleSort('user_id')">User ID<span id="sort_user_id"></span></th>
          <th onclick="toggleSort('customer_email')">Email<span id="sort_customer_email"></span></th>
          <th onclick="toggleSort('checklist_score')">Score<span id="sort_checklist_score"></span></th>
          <th onclick="toggleSort('checklist_status')">Status<span id="sort_checklist_status"></span></th>
          <th onclick="toggleSort('selected_indicator_codes')">Indicators<span id="sort_selected_indicator_codes"></span></th>
          <th onclick="toggleSort('_analyzed_at')">Analyzed<span id="sort__analyzed_at"></span></th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>
</div>

<!-- Footer -->
<div class="footer">
  <p>ARMOR Checklist Dashboard v4.0 | <a href="#" onclick="document.getElementById('helpModal').classList.add('active');return false;">Setup Guide</a> | Press <span class="kbd">?</span> for keyboard shortcuts</p>
  <p class="powered">Powered by ARMOR Analytics Engine</p>
</div>

<!-- Detail Panel -->
<div class="overlay" id="overlay" onclick="closeDetail()"></div>
<div class="detail-panel" id="detailPanel">
  <div class="detail-header">
    <div>
      <h2 id="detailCompany"></h2>
      <p id="detailEmail"></p>
    </div>
    <button class="detail-close" onclick="closeDetail()">ESC Close</button>
  </div>
  <div class="detail-body" id="detailBody"></div>
</div>

<!-- Paste Modal -->
<div class="modal" id="pasteModal">
  <div class="modal-box">
    <h3>Paste JSON Results</h3>
    <p>Paste one or more JSON evaluation results (single object, array, or one-per-line JSONL format).</p>
    <textarea id="pasteArea" placeholder='{"company":"...","checklist_score":33,...}'></textarea>
    <div class="modal-actions">
      <button class="btn-secondary" onclick="document.getElementById('pasteModal').classList.remove('active')">Cancel</button>
      <button class="btn-primary" onclick="handlePasteImport()">Import Data</button>
    </div>
  </div>
</div>

<!-- Config Modal -->
<div class="modal" id="configModal">
  <div class="modal-box">
    <h3>Sync Settings</h3>
    <p>Connect to Google Sheets for real-time team collaboration. Data syncs automatically across all teammates.</p>

    <div class="auto-sync-row">
      <label>Auto-sync every 60 seconds</label>
      <label class="toggle-switch">
        <input type="checkbox" id="autoSyncToggle" onchange="toggleAutoSync()">
        <span class="toggle-slider"></span>
      </label>
    </div>

    <label style="font-size:11px;color:#64748b;font-weight:700;display:block;margin-bottom:8px;text-transform:uppercase;letter-spacing:1px;">Sync URL</label>
    <input type="text" id="scriptUrlInput" placeholder="https://script.google.com/macros/s/.../exec">

    <div class="config-status">
      <strong>Status:</strong> <span id="configStatusText">Not connected</span>
    </div>

    <div id="lastSyncTime" style="font-size:12px;color:#475569;margin-bottom:20px;"></div>

    <div class="modal-actions">
      <button class="btn-secondary" onclick="disconnectSync()">Disconnect</button>
      <button class="btn-secondary" onclick="document.getElementById('configModal').classList.remove('active')">Cancel</button>
      <button class="btn-primary" onclick="saveAndTestSync()">Save & Connect</button>
    </div>
  </div>
</div>

<!-- Help Modal -->
<div class="modal help-modal" id="helpModal">
  <div class="modal-box">
    <h3>ARMOR Dashboard Setup Guide</h3>
    <p>Welcome to the most advanced checklist analyzer dashboard. Follow these steps to get started.</p>

    <div class="help-section">
      <h4><span class="step-num">1</span> What You Need</h4>
      <ul class="help-list">
        <li>Google Chrome browser (recommended)</li>
        <li>The dashboard PIN (default: 1414)</li>
        <li>The sync URL (provided below)</li>
      </ul>
    </div>

    <div class="help-section">
      <h4><span class="step-num">2</span> Enter the PIN</h4>
      <p>Type the 4-digit PIN and click Unlock. Required once per browser session.</p>
    </div>

    <div class="help-section">
      <h4><span class="step-num">3</span> Connect to Shared Data</h4>
      <p>Click <strong>Sync Settings</strong>, paste the URL below, and click <strong>Save & Connect</strong>.</p>
      <div class="code-block" id="syncUrlDisplay">https://script.google.com/macros/s/AKfycbx-0XkYj2qeJ5H1enP0-ov6ZtlkaFjXlp8uIi-RzYhdkyT-oOB5FPrUCoEDdJZ3AaoxVA/exec</div>
      <button class="btn-secondary" style="margin-top:10px;font-size:12px;padding:10px 20px;" onclick="copyUrl()">Copy URL</button>
    </div>

    <div class="help-section">
      <h4><span class="step-num">4</span> Keyboard Shortcuts</h4>
      <ul class="help-list">
        <li><span class="kbd">/</span> Focus search box</li>
        <li><span class="kbd">H</span> Open help</li>
        <li><span class="kbd">R</span> Refresh data</li>
        <li><span class="kbd">ESC</span> Close panels/modals</li>
      </ul>
    </div>

    <div class="help-tip">
      <strong>Pro Tips</strong>
      <p><strong>Auto-sync:</strong> Enable in settings for automatic 60-second refresh.</p>
      <p><strong>Offline mode:</strong> Works offline with local cache.</p>
      <p><strong>Team sync:</strong> All changes sync to teammates in real-time.</p>
    </div>

    <div class="help-warning">
      <strong>Security Notice</strong>
      <p>Do not share credentials with customers. This dashboard contains sensitive evaluation data.</p>
    </div>

    <div class="modal-actions">
      <button class="btn-primary" onclick="document.getElementById('helpModal').classList.remove('active')">Got It!</button>
    </div>
  </div>
</div>

</div><!-- /app-content -->

<script>
// ── Create particles ──
function createParticles(containerId, count = 50) {
  const container = document.getElementById(containerId);
  if (!container) return;
  for (let i = 0; i < count; i++) {
    const particle = document.createElement('div');
    particle.className = 'particle';
    particle.style.left = Math.random() * 100 + '%';
    particle.style.animationDelay = Math.random() * 20 + 's';
    particle.style.animationDuration = (15 + Math.random() * 10) + 's';
    container.appendChild(particle);
  }
}

createParticles('particles', 30);
createParticles('lockParticles', 40);

// ── Toast notifications ──
function showToast(message, type = 'info') {
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');
  toast.className = 'toast ' + type;
  toast.innerHTML = message;
  container.appendChild(toast);
  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transform = 'translateX(100px)';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

// ── Configuration ──
const DEFAULT_SYNC_URL = 'https://script.google.com/macros/s/AKfycbx-0XkYj2qeJ5H1enP0-ov6ZtlkaFjXlp8uIi-RzYhdkyT-oOB5FPrUCoEDdJZ3AaoxVA/exec';
const AUTO_SYNC_INTERVAL = 60000;

// ── PIN Authentication ──
const PIN_HASH = 'fbce66f99c809283638f344ecb3d50674ea64189';
const PIN_SESSION_KEY = 'armor_pin_authenticated';

async function hashPin(pin) {
  const data = new TextEncoder().encode(pin);
  const hashBuffer = await crypto.subtle.digest('SHA-1', data);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

async function checkPin() {
  const pin = document.getElementById('pinInput').value;
  const hash = await hashPin(pin);
  if (hash === PIN_HASH) {
    sessionStorage.setItem(PIN_SESSION_KEY, 'true');
    unlockApp();
  } else {
    document.getElementById('pinError').textContent = 'Incorrect PIN';
    document.getElementById('pinInput').value = '';
    document.getElementById('pinInput').focus();
  }
}

function unlockApp() {
  document.getElementById('lockScreen').classList.add('hidden');
  document.getElementById('appContent').classList.add('unlocked');
  initApp();
  showToast('Welcome to ARMOR Dashboard v4.0', 'success');
}

if (sessionStorage.getItem(PIN_SESSION_KEY) === 'true') {
  unlockApp();
} else {
  document.getElementById('pinInput').focus();
}

// ── Keyboard shortcuts ──
document.addEventListener('keydown', (e) => {
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

  if (e.key === '/') {
    e.preventDefault();
    document.getElementById('searchInput')?.focus();
  } else if (e.key === 'h' || e.key === 'H') {
    document.getElementById('helpModal').classList.add('active');
  } else if (e.key === 'r' || e.key === 'R') {
    manualSync();
  } else if (e.key === 'Escape') {
    document.getElementById('helpModal').classList.remove('active');
    document.getElementById('configModal').classList.remove('active');
    document.getElementById('pasteModal').classList.remove('active');
    closeDetail();
  }
});

// ── Sync Config ──
const SYNC_URL_KEY = 'armor_checklist_dashboard_sync_url';
const AUTO_SYNC_KEY = 'armor_auto_sync_enabled';
let autoSyncTimer = null;
let lastSyncTime = null;

function getSyncUrl() { try { return localStorage.getItem(SYNC_URL_KEY) || ''; } catch(e) { return ''; } }
function setSyncUrl(url) { try { localStorage.setItem(SYNC_URL_KEY, url); } catch(e) {} }
function isCloudMode() { return !!getSyncUrl(); }
function getAutoSync() { try { return localStorage.getItem(AUTO_SYNC_KEY) === 'true'; } catch(e) { return false; } }
function setAutoSync(enabled) { try { localStorage.setItem(AUTO_SYNC_KEY, enabled ? 'true' : 'false'); } catch(e) {} }

function toggleAutoSync() {
  const enabled = document.getElementById('autoSyncToggle').checked;
  setAutoSync(enabled);
  if (enabled && isCloudMode()) { startAutoSync(); showToast('Auto-sync enabled', 'success'); }
  else { stopAutoSync(); }
  updateSyncStatusDisplay();
}

function startAutoSync() {
  stopAutoSync();
  autoSyncTimer = setInterval(async () => { if (isCloudMode()) await cloudFetch(); }, AUTO_SYNC_INTERVAL);
}

function stopAutoSync() { if (autoSyncTimer) { clearInterval(autoSyncTimer); autoSyncTimer = null; } }

function manualSync() {
  if (isCloudMode()) {
    cloudFetch();
    showToast('Syncing data...', 'info');
  } else {
    showToast('Connect to sync first', 'error');
  }
}

function updateSyncStatusDisplay() {
  const el = document.getElementById('syncStatus');
  const url = getSyncUrl();
  const autoSync = getAutoSync();
  if (!url) {
    el.className = 'sync-indicator sync-local';
    el.innerHTML = '<span class="sync-dot"></span> Local Only';
  } else if (autoSync && autoSyncTimer) {
    el.className = 'sync-indicator sync-connected';
    el.innerHTML = `<span class="sync-dot"></span> Live (${submissions.length})`;
  } else {
    el.className = 'sync-indicator sync-connected';
    el.innerHTML = `<span class="sync-dot"></span> Synced (${submissions.length})`;
  }
}

function updateSyncStatus(state, text) {
  const el = document.getElementById('syncStatus');
  el.className = 'sync-indicator sync-' + state;
  el.innerHTML = `<span class="sync-dot"></span> ${text}`;
}

function updateLastSyncTime() {
  lastSyncTime = new Date();
  const el = document.getElementById('lastSyncTime');
  if (el) el.textContent = 'Last synced: ' + lastSyncTime.toLocaleTimeString();
}

async function saveAndTestSync() {
  const url = document.getElementById('scriptUrlInput').value.trim();
  if (!url) { disconnectSync(); return; }
  document.getElementById('configStatusText').textContent = 'Testing connection...';
  try {
    const resp = await fetch(url);
    const json = await resp.json();
    if (json.success) {
      setSyncUrl(url);
      document.getElementById('configStatusText').textContent = 'Connected! ' + json.data.length + ' submissions found.';
      updateLastSyncTime();
      submissions = deduplicateSubmissions(json.data);
      saveToStorage();
      renderStats();
      renderTable();
      if (getAutoSync()) startAutoSync();
      updateSyncStatusDisplay();
      showToast('Connected! ' + json.data.length + ' submissions loaded', 'success');
      setTimeout(() => { document.getElementById('configModal').classList.remove('active'); }, 1000);
    } else {
      document.getElementById('configStatusText').textContent = 'Error: ' + (json.error || 'Unknown');
      showToast('Connection failed', 'error');
    }
  } catch (err) {
    document.getElementById('configStatusText').textContent = 'Failed: ' + err.message;
    showToast('Connection failed', 'error');
  }
}

function disconnectSync() {
  setSyncUrl('');
  stopAutoSync();
  document.getElementById('scriptUrlInput').value = '';
  document.getElementById('configStatusText').textContent = 'Disconnected';
  document.getElementById('configModal').classList.remove('active');
  updateSyncStatusDisplay();
  showToast('Disconnected from sync', 'info');
}

async function cloudFetch() {
  const url = getSyncUrl();
  if (!url) return null;
  try {
    updateSyncStatus('loading', 'Syncing...');
    const resp = await fetch(url);
    const json = await resp.json();
    if (json.success) {
      submissions = deduplicateSubmissions(json.data);
      saveToStorage();
      renderStats();
      renderTable();
      updateLastSyncTime();
      updateSyncStatusDisplay();
      return json.data;
    } else {
      updateSyncStatus('error', 'Error');
      return null;
    }
  } catch (err) {
    updateSyncStatus('error', 'Offline');
    return null;
  }
}

async function cloudSave(items) {
  const url = getSyncUrl();
  if (!url) return null;
  try {
    await fetch(url, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ submissions: Array.isArray(items) ? items : [items] }) });
    await new Promise(r => setTimeout(r, 2000));
    await cloudFetch();
    return { success: true };
  } catch (err) {
    updateSyncStatus('error', 'Save failed');
    return null;
  }
}

async function cloudDelete(email) {
  const url = getSyncUrl();
  if (!url) return false;
  try {
    await fetch(url, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'delete', customer_email: email }) });
    await new Promise(r => setTimeout(r, 2000));
    return true;
  } catch (err) { return false; }
}

async function fetchChecklistQA(email) {
  const url = getSyncUrl();
  if (!url) return null;
  try {
    const resp = await fetch(url + '?action=qa&email=' + encodeURIComponent(email));
    const json = await resp.json();
    if (json.success) return json.qa;
    return null;
  } catch (err) { return null; }
}

function renderQASection(containerId, qaData) {
  const el = document.getElementById(containerId);
  if (!el) return;
  if (!qaData || qaData.length === 0) {
    el.innerHTML = '<p class="qa-unavailable">No original checklist submission data found for this customer</p>';
    return;
  }
  const qaItems = qaData.filter(item => item.col >= 6);
  if (qaItems.length === 0) {
    el.innerHTML = '<p class="qa-unavailable">No original checklist submission data found for this customer</p>';
    return;
  }
  el.innerHTML = qaItems.map(item => `<div class="qa-item"><div class="qa-q">${item.question}</div><div class="qa-a">${item.answer}</div></div>`).join('');
}

function copyUrl() {
  const url = document.getElementById('syncUrlDisplay').textContent;
  navigator.clipboard.writeText(url).then(() => {
    showToast('URL copied to clipboard!', 'success');
  });
}

// ── Copy helper ──
function copyToClipboard(text, btnEl) {
  navigator.clipboard.writeText(text).then(() => {
    if (btnEl) {
      const orig = btnEl.textContent;
      btnEl.textContent = 'Copied!';
      btnEl.classList.add('copied');
      setTimeout(() => { btnEl.textContent = orig; btnEl.classList.remove('copied'); }, 1500);
    }
    showToast('Copied to clipboard', 'success');
  }).catch(() => {});
}

// ── Clarification helpers ──
function escapeHtml(str) {
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function parseClarificationEntries(text) {
  if (!text || !text.trim()) return [];
  const parts = text.split(/\n---\n/).map(p => p.trim()).filter(Boolean);
  return parts.map(p => {
    const dateMatch = p.match(/^\[(\d{4}-\d{2}-\d{2})(?:,\s*edited\s+(\d{4}-\d{2}-\d{2}))?\]\s*/);
    if (dateMatch) {
      return { date: dateMatch[1], editedDate: dateMatch[2] || null, text: p.substring(dateMatch[0].length).trim() };
    }
    return { date: null, editedDate: null, text: p };
  });
}

function buildClarificationString(entries) {
  return entries.map(e => {
    if (e.date && e.editedDate) return '[' + e.date + ', edited ' + e.editedDate + '] ' + e.text;
    if (e.date) return '[' + e.date + '] ' + e.text;
    return e.text;
  }).join('\n---\n');
}

function syncClarification(idx) {
  saveToStorage();
  if (isCloudMode()) {
    if (clarSyncTimer) clearTimeout(clarSyncTimer);
    clarSyncTimer = setTimeout(() => {
      const combined = submissions[idx].customer_clarification || '';
      const url = getSyncUrl();
      fetch(url, {
        method: 'POST',
        mode: 'no-cors',
        body: JSON.stringify({ submissions: [submissions[idx]] })
      }).catch(() => {});
      const email = submissions[idx].customer_email;
      if (email) {
        fetch(url, {
          method: 'POST',
          mode: 'no-cors',
          body: JSON.stringify({ action: 'clarification', customer_email: email, clarification: combined })
        }).catch(() => {});
      }
      clarSyncTimer = null;
    }, 1500);
  }
}

function deleteClarificationEntry(idx, entryIdx) {
  const existing = submissions[idx].customer_clarification || '';
  const entries = parseClarificationEntries(existing);
  entries.splice(entryIdx, 1);
  submissions[idx].customer_clarification = buildClarificationString(entries);
  syncClarification(idx);
  openDetail(idx);
  showToast('Entry deleted', 'info');
}

function renderClarEntry(entry, i, submissionIdx) {
  var entryId = 'clarEntry_' + i;
  var isEditing = editingClarEntry && editingClarEntry.idx === submissionIdx && editingClarEntry.entryIdx === i;
  if (isEditing) {
    return '<div class="clarification-entry" style="border-color:var(--primary)">'
      + '<div class="clarification-entry-header">'
      + '<span class="clarification-date">' + (entry.date ? entry.date : 'Initial entry') + '<span class="clarification-edited-tag">(editing)</span></span>'
      + '</div>'
      + '<textarea id="clarEditArea" style="width:100%;min-height:80px;padding:12px;border-radius:10px;border:2px solid var(--primary);font-size:14px;font-family:inherit;resize:vertical;background:rgba(0,0,0,0.3);color:#e2e8f0">' + escapeHtml(entry.text) + '</textarea>'
      + '<div style="display:flex;gap:10px;margin-top:12px">'
      + '<button class="save-btn" onclick="saveEditClarification(' + submissionIdx + ', ' + i + ')" style="font-size:13px;padding:10px 20px">Save Edit</button>'
      + '<button onclick="cancelEditClarification(' + submissionIdx + ')" style="padding:10px 20px;background:rgba(255,255,255,0.1);color:#94a3b8;border:1px solid rgba(255,255,255,0.1);border-radius:10px;font-size:13px;cursor:pointer;font-weight:600">Cancel</button>'
      + '</div></div>';
  }
  var dateLabel = entry.date ? entry.date : 'Initial entry';
  if (entry.editedDate) dateLabel += '<span class="clarification-edited-tag">(edited ' + entry.editedDate + ')</span>';
  return '<div class="clarification-entry">'
    + '<div class="clarification-entry-header">'
    + '<span class="clarification-date">' + dateLabel + '</span>'
    + '<span>'
    + '<button class="clarification-action-btn" onclick="editClarificationEntry(' + submissionIdx + ', ' + i + ')" title="Edit">Edit</button>'
    + '<button class="clarification-action-btn" onclick="copyToClipboard(document.getElementById(\'' + entryId + '\').textContent, this)" title="Copy">Copy</button>'
    + '<button class="clarification-action-btn delete" onclick="deleteClarificationEntry(' + submissionIdx + ', ' + i + ')" title="Delete">&times;</button>'
    + '</span></div>'
    + '<div class="clarification-entry-text" id="' + entryId + '">' + escapeHtml(entry.text) + '</div>'
    + '</div>';
}

function editClarificationEntry(idx, entryIdx) {
  editingClarEntry = { idx: idx, entryIdx: entryIdx };
  openDetail(idx);
}

function saveEditClarification(idx, entryIdx) {
  var newText = document.getElementById('clarEditArea').value.trim();
  if (!newText) return;
  var existing = submissions[idx].customer_clarification || '';
  var entries = parseClarificationEntries(existing);
  if (entryIdx < entries.length) {
    entries[entryIdx].text = newText;
    entries[entryIdx].editedDate = new Date().toISOString().slice(0, 10);
    submissions[idx].customer_clarification = buildClarificationString(entries);
    editingClarEntry = null;
    syncClarification(idx);
    openDetail(idx);
    showToast('Entry updated', 'success');
  }
}

function cancelEditClarification(idx) {
  editingClarEntry = null;
  openDetail(idx);
}

function toggleOlderClarifications(idx) {
  showOlderClarifications = !showOlderClarifications;
  openDetail(idx);
}

// ── Persistence ──
const STORAGE_KEY = 'armor_checklist_dashboard_submissions';
function saveToStorage() { try { localStorage.setItem(STORAGE_KEY, JSON.stringify(submissions)); } catch(e) {} }
function loadFromStorage() { try { const raw = localStorage.getItem(STORAGE_KEY); if (raw) return JSON.parse(raw); } catch(e) {} return null; }

// ── State ──
let submissions = [];
let selectedIdx = null;
let sortField = '_analyzed_at';
let sortDir = 'desc';
let editingClarEntry = null;
let showOlderClarifications = false;
let clarSyncTimer = null;

const SAMPLE = {
  company: "Minnesota Insurance Agencies",
  customer_email: "ryan.libby@midwestinsuranceagencies.com",
  user_id: "1253984611",
  answer_purpose: "Minnesota Insurance Agencies states the purpose of their calls is to provide value, build relationships, or deliver necessary information. No specific product, service, or recipient profile is described.",
  answer_reaction: "The caller states recipients may react poorly because they may be busy at the time or have technical issues.",
  checklist_summary: 'These calls are potentially unwanted / at face value, these calls sound "spammy"',
  checklist_score: 33,
  checklist_status: "Insufficient",
  selected_indicator_codes: "h,l,n,q,r",
  selected_indicators: [
    {id:"H",type:"Bad",label:"Bad – calls are not requested by recipient",evidence:["Caller answered 'No' to direct consent and 'No' to prior business relationship. No evidence of recipient-initiated contact or opt-in."],customer_message:"Carriers consider calls that are not explicitly requested by recipients to be deserving of spam flags, especially when there is evidence of negative consumer feedback such as low answer rates, short call durations, customer complaints, or number blocks. When calls are viewed as unexpected or unsolicited, remediation options are extremely limited, and ARMOR is not able to pursue further remediation until calling practices or consumer feedback change materially."},
    {id:"L",type:"Inconclusive",label:"Inconclusive – unclear call purpose",evidence:["Call purpose is described as 'to provide value, build relationships, or deliver necessary information.' This is generic and does not identify the business type, product, service, or recipient profile."],customer_message:"Carriers evaluate whether calls are appropriate based on a clear, consistent call purpose. Please describe what your business does, who you call, and the primary purpose of your calls."},
    {id:"N",type:"Inconclusive",label:"Inconclusive – unclear lead sources or processes",evidence:["Lead curation is described only as 'Our numbers are verified with software.' No explanation is provided for where leads originate or how contact information is obtained."],customer_message:"Lead quality creates clear signals carriers use to evaluate whether calls are expected and/or well-received by recipients. Please describe how you get your leads, and ensure they are well-targeted to your product/service."},
    {id:"Q",type:"Inconclusive",label:"Inconclusive – Do Not Call process unclear",evidence:["The DNC explanation only directs recipients to register on the national donotcall.gov registry. No internal operational process is described for honoring opt-out requests."],customer_message:"Carriers expect clear Do-Not-Call controls to ensure recipients on the list are not contacted. Please describe how you prevent calling contacts on the Do-Not-Call list, how opt-out options are disclosed to contacts, and how opt-out requests are handled and enforced."},
    {id:"R",type:"Inconclusive",label:"Inconclusive – call timing and frequency controls are unclear",evidence:["Frequency is partially addressed but no call timing limits are described — no business-hour windows, time-zone restrictions, or weekday-only policies."],customer_message:"Even requested calls can become a nuisance if they are too frequent, too close together, or placed at inopportune times. Please describe how call timing is determined and how call frequency is limited."}
  ],
  checklist_summary_notes: [
    "No evidence of prior business relationship or recipient-initiated request; calls are classified as unrequested.",
    "Call purpose, lead sourcing, DNC process, and call timing controls are all insufficiently described.",
    "Summary is Potentially Unwanted because unrequested calls (H) are paired with multiple unresolved ambiguities (L, N, Q, R)."
  ],
  customer_clarification: "",
  _analyzed_at: new Date().toISOString()
};

function deduplicateSubmissions(arr) {
  const seen = new Map();
  arr.forEach(s => {
    const key = (s.customer_email || '').toLowerCase().trim();
    if (!key) { seen.set(Math.random().toString(), s); return; }
    const existing = seen.get(key);
    if (!existing || (s._analyzed_at || '') > (existing._analyzed_at || '')) {
      if (existing && !s.customer_clarification && existing.customer_clarification) s.customer_clarification = existing.customer_clarification;
      seen.set(key, s);
    }
  });
  return Array.from(seen.values());
}

const saved = loadFromStorage();
if (saved && saved.length > 0) {
  submissions = deduplicateSubmissions(saved);
  if (submissions.length !== saved.length) saveToStorage();
} else {
  submissions.push(SAMPLE);
  saveToStorage();
}

// ── Helpers ──
function badgeClass(type) { return type === 'Good' ? 'badge-good' : type === 'Bad' ? 'badge-bad' : 'badge-inconclusive'; }
function indicatorBadges(indicators) { return (indicators || []).map(i => `<span class="badge ${badgeClass(i.type)}">${i.id}</span>`).join(''); }
function scoreBadge(score) { return `<span class="score-badge score-${score}">${score}</span>`; }
function statusBadge(status) { return `<span class="status-badge status-${status.toLowerCase()}">${status}</span>`; }
function getKey(s) { return (s.customer_email || '').toLowerCase().trim(); }
function importMessage(r) {
  const parts = [];
  if (r.added) parts.push(r.added + ' new');
  if (r.replaced) parts.push(r.replaced + ' updated');
  return parts.length ? parts.join(', ') : 'No changes';
}

// ── Stats ──
function renderStats() {
  const total = submissions.length;
  const suf = submissions.filter(s => s.checklist_status === 'Sufficient').length;
  const insuf = total - suf;
  const s33 = submissions.filter(s => s.checklist_score === 33).length;
  const s66 = submissions.filter(s => s.checklist_score === 66).length;
  const s100 = submissions.filter(s => s.checklist_score === 100).length;

  document.getElementById('statsRow').innerHTML = [
    {l:'Total',v:total,c:'purple'},
    {l:'Sufficient',v:suf,c:'green'},
    {l:'Insufficient',v:insuf,c:'red'},
    {l:'Score 33',v:s33,c:'red'},
    {l:'Score 66',v:s66,c:'yellow'},
    {l:'Score 100',v:s100,c:'green'}
  ].map(s => `<div class="stat-card ${s.c} glass-light"><div class="stat-label">${s.l}</div><div class="stat-value">${s.v}</div></div>`).join('');
}

// ── Filtering & Sorting ──
function getFiltered() {
  const search = document.getElementById('searchInput').value.toLowerCase();
  const scoreF = document.getElementById('scoreFilter').value;
  const statusF = document.getElementById('statusFilter').value;
  let result = submissions.filter(s => {
    if (scoreF !== 'all' && s.checklist_score !== Number(scoreF)) return false;
    if (statusF !== 'all' && s.checklist_status !== statusF) return false;
    if (search) return (s.company||'').toLowerCase().includes(search) || (s.customer_email||'').toLowerCase().includes(search) || (s.user_id||'').includes(search);
    return true;
  });
  result.sort((a, b) => {
    let av = a[sortField] || '', bv = b[sortField] || '';
    if (typeof av === 'number') return sortDir === 'asc' ? av - bv : bv - av;
    return sortDir === 'asc' ? String(av).localeCompare(String(bv)) : String(bv).localeCompare(String(av));
  });
  return result;
}

function toggleSort(field) {
  if (sortField === field) sortDir = sortDir === 'asc' ? 'desc' : 'asc';
  else { sortField = field; sortDir = 'asc'; }
  renderTable();
}

// ── Table ──
function renderTable() {
  ['company','user_id','customer_email','checklist_score','checklist_status','selected_indicator_codes','_analyzed_at'].forEach(f => {
    const el = document.getElementById('sort_' + f);
    if (el) el.textContent = sortField === f ? (sortDir === 'asc' ? ' ↑' : ' ↓') : '';
  });
  const filtered = getFiltered();
  document.getElementById('filterCount').textContent = filtered.length + ' result' + (filtered.length !== 1 ? 's' : '');
  const tbody = document.getElementById('tableBody');
  if (filtered.length === 0) {
    tbody.innerHTML = '<tr class="empty-row"><td colspan="7">No submissions found</td></tr>';
    return;
  }
  tbody.innerHTML = filtered.map((s, i) => {
    const idx = submissions.indexOf(s);
    const date = s._analyzed_at ? new Date(s._analyzed_at).toLocaleDateString() : '—';
    return `<tr class="${selectedIdx === idx ? 'selected' : ''}" onclick="openDetail(${idx})">
      <td style="font-weight:700;color:#e2e8f0">${s.company || '—'}</td>
      <td style="color:#64748b;font-family:monospace;font-size:12px">${s.user_id || '—'}</td>
      <td style="color:#94a3b8">${s.customer_email || '—'}</td>
      <td>${scoreBadge(s.checklist_score)}</td>
      <td>${statusBadge(s.checklist_status)}</td>
      <td>${indicatorBadges(s.selected_indicators)}</td>
      <td style="color:#64748b;font-size:12px">${date}</td>
    </tr>`;
  }).join('');
}

// ── Detail Panel ──
function openDetail(idx) {
  if (selectedIdx !== idx) { showOlderClarifications = false; editingClarEntry = null; }
  selectedIdx = idx;
  const s = submissions[idx];
  document.getElementById('detailCompany').textContent = s.company || 'Unknown';
  document.getElementById('detailEmail').textContent = s.customer_email || '';

  let html = '';

  // Score row
  html += `<div class="detail-row">
    <div class="detail-card"><div class="detail-card-label">Score</div>${scoreBadge(s.checklist_score)}</div>
    <div class="detail-card"><div class="detail-card-label">Status</div>${statusBadge(s.checklist_status)}</div>
    <div class="detail-card" style="flex:2"><div class="detail-card-label">User ID</div><span class="mono">${s.user_id || '—'}</span></div>
  </div>`;

  // Summary
  html += `<div class="summary-card">
    <div class="detail-card-label">Checklist Summary</div>
    <p class="main">${s.checklist_summary || 'N/A'}</p>
    ${(s.checklist_summary_notes||[]).length ? '<div class="summary-notes">' + s.checklist_summary_notes.map(n => `<p>• ${n}</p>`).join('') + '</div>' : ''}
  </div>`;

  // Purpose & Reaction (with copy buttons)
  html += `<div class="detail-row">
    <div class="detail-card"><div class="detail-card-label">Call Purpose <button class="copy-btn" onclick="copyToClipboard(document.getElementById('valPurpose').textContent, this)">Copy</button></div><p id="valPurpose">${s.answer_purpose || 'N/A'}</p></div>
    <div class="detail-card"><div class="detail-card-label">Potential Reaction <button class="copy-btn" onclick="copyToClipboard(document.getElementById('valReaction').textContent, this)">Copy</button></div><p id="valReaction">${s.answer_reaction || 'N/A'}</p></div>
  </div>`;

  // Indicators
  html += `<div class="indicators-section">
    <h3>Selected Indicators (${(s.selected_indicators||[]).length})</h3>
    <div style="margin-bottom:16px">${indicatorBadges(s.selected_indicators)}</div>`;

  (s.selected_indicators || []).forEach((ind, i) => {
    const cls = ind.type === 'Good' ? 'good' : ind.type === 'Bad' ? 'bad' : 'inconclusive';
    html += `<div class="indicator-card ${cls}">
      <button class="indicator-toggle" onclick="toggleIndicator(${i})">
        <span class="left"><span class="badge badge-${cls}">${ind.id}</span><span class="label">${ind.label}</span></span>
        <span class="arrow" id="arrow_${i}">▼</span>
      </button>
      <div class="indicator-detail" id="indDetail_${i}">
        <div><strong>Evidence:</strong>${(ind.evidence||[]).map(e => `<p>${e}</p>`).join('')}</div>
        ${ind.customer_message ? `<div class="customer-msg"><strong>Customer Message:</strong><p>${ind.customer_message}</p></div>` : ''}
      </div>
    </div>`;
  });
  html += '</div>';

  // Clarification section with full entry management
  const clarText = s.customer_clarification || (s.reanalysis && s.reanalysis.clarification_summary) || '';
  const clarEntries = parseClarificationEntries(clarText);
  html += `<div class="clarification-section">
    <div class="label">Customer Clarification</div>
    <p class="clarification-explainer">Use this section to capture clarification information from the customer, and address the Bad or Inconclusive indicators shown here. This information will be used to re-analyze the Checklist Submission as a whole.</p>`;

  if (clarEntries.length > 0) {
    if (clarEntries.length > 3) {
      const olderCount = clarEntries.length - 1;
      if (showOlderClarifications) {
        for (let i = 0; i < olderCount; i++) html += renderClarEntry(clarEntries[i], i, idx);
      }
      html += `<button class="clarification-collapse-btn" onclick="toggleOlderClarifications(${idx})">
        ${showOlderClarifications ? 'Hide older entries ▲' : 'Show ' + olderCount + ' older entr' + (olderCount === 1 ? 'y' : 'ies') + ' ▼'}
      </button>`;
      html += renderClarEntry(clarEntries[clarEntries.length - 1], clarEntries.length - 1, idx);
    } else {
      for (let i = 0; i < clarEntries.length; i++) html += renderClarEntry(clarEntries[i], i, idx);
    }
  }

  html += `<textarea id="clarificationInput" placeholder="${clarEntries.length > 0 ? 'Add additional clarification...' : 'Add customer clarification notes here...'}"></textarea>
    <div class="save-row">
      <button class="save-btn" onclick="saveClarification(${idx})">Save</button>
      <span class="save-confirm" id="saveConfirm" style="display:none">Saved & synced!</span>
    </div>
  </div>`;

  // Reanalysis
  if (s.reanalysis) {
    html += `<div class="reanalysis-section">
      <div class="detail-card-label" style="color:#34d399;font-weight:700">Re-analysis Results</div>
      <p style="font-size:14px;color:#cbd5e1;margin:8px 0 12px">${s.reanalysis.clarification_summary || ''}</p>
      ${(s.reanalysis.change_log||[]).map(c => `<div style="font-size:13px;color:#94a3b8;padding:6px 0"><span class="badge ${c.action==='added'?'badge-bad':'badge-good'}">${c.action}</span> ${c.indicator_id}: ${c.reason}</div>`).join('')}
    </div>`;
  }

  // Manual Override
  html += `<div class="override-section">
    <div class="detail-card-label" style="color:#a78bfa;font-weight:700">Manual Override</div>
    ${s.override_log && s.override_log.applied
      ? `<div style="display:flex;gap:20px;margin:12px 0">
          <div style="flex:1"><span style="font-size:11px;color:#64748b;font-weight:700;text-transform:uppercase">Added:</span>
            <span style="font-size:14px;color:#cbd5e1;margin-left:8px">${(s.override_log.added || []).join(', ') || 'None'}</span></div>
          <div style="flex:1"><span style="font-size:11px;color:#64748b;font-weight:700;text-transform:uppercase">Removed:</span>
            <span style="font-size:14px;color:#cbd5e1;margin-left:8px">${(s.override_log.removed || []).join(', ') || 'None'}</span></div>
        </div>
        ${s.override_log.reason ? `<div style="margin-top:12px;padding:14px;background:rgba(0,0,0,0.2);border-radius:10px;border:1px solid rgba(139,92,246,0.2)">
          <span style="font-size:11px;color:#64748b;font-weight:700;text-transform:uppercase">Reason:</span>
          <p style="font-size:14px;color:#cbd5e1;margin:8px 0 0">${s.override_log.reason}</p>
        </div>` : ''}`
      : `<p style="font-size:14px;color:#64748b;margin:12px 0 0;font-style:italic">No manual override applied</p>`
    }
  </div>`;

  // Original Checklist Q&A
  html += `<div class="qa-section">
    <div class="qa-header">Original Checklist Submission from Customer</div>
    <div id="qaContent">${isCloudMode()
      ? '<p class="qa-loading">Loading original checklist submission...</p>'
      : '<p class="qa-unavailable">Connect to Google Sheets to view original checklist submission</p>'
    }</div>
  </div>`;

  // Delete
  html += `<div style="border-top:1px solid rgba(255,255,255,0.1);padding-top:24px;margin-top:20px;display:flex;gap:12px">
    <span id="deleteInitial"><button onclick="showDeleteConfirm()" style="padding:12px 24px;background:linear-gradient(135deg,rgba(239,68,68,0.2),rgba(220,38,38,0.2));color:#f87171;border:1px solid rgba(239,68,68,0.3);border-radius:12px;font-size:13px;cursor:pointer;font-weight:700;transition:all 0.3s">Delete this submission</button></span>
    <span id="deleteConfirm" style="display:none;align-items:center;gap:10px">
      <span style="color:#f87171;font-weight:600">Are you sure?</span>
      <button onclick="confirmDelete()" style="padding:12px 20px;background:linear-gradient(135deg,#ef4444,#dc2626);color:#fff;border:none;border-radius:12px;font-size:13px;cursor:pointer;font-weight:700">Yes, delete</button>
      <button onclick="cancelDelete()" style="padding:12px 20px;background:rgba(255,255,255,0.1);color:#94a3b8;border:1px solid rgba(255,255,255,0.1);border-radius:12px;font-size:13px;cursor:pointer;font-weight:600">Cancel</button>
    </span>
  </div>`;

  document.getElementById('detailBody').innerHTML = html;
  document.getElementById('overlay').classList.add('active');
  document.getElementById('detailPanel').classList.add('active');
  renderTable();

  // Async load Q&A if connected
  if (isCloudMode() && s.customer_email) {
    fetchChecklistQA(s.customer_email).then(qa => {
      renderQASection('qaContent', qa);
    });
  }
}

function closeDetail() {
  selectedIdx = null;
  document.getElementById('overlay').classList.remove('active');
  document.getElementById('detailPanel').classList.remove('active');
  renderTable();
}

function toggleIndicator(i) {
  const detail = document.getElementById('indDetail_' + i);
  const arrow = document.getElementById('arrow_' + i);
  detail.classList.toggle('open');
  arrow.classList.toggle('open');
}

function saveClarification(idx) {
  const newText = document.getElementById('clarificationInput').value.trim();
  if (!newText) return;
  const existing = submissions[idx].customer_clarification || '';
  const entries = parseClarificationEntries(existing);
  const today = new Date().toISOString().slice(0, 10);
  entries.push({ date: today, text: newText });
  submissions[idx].customer_clarification = buildClarificationString(entries);
  syncClarification(idx);
  openDetail(idx);
  showToast('Clarification saved & synced!', 'success');
}

function showDeleteConfirm() { document.getElementById('deleteInitial').style.display = 'none'; document.getElementById('deleteConfirm').style.display = 'flex'; }
function cancelDelete() { document.getElementById('deleteConfirm').style.display = 'none'; document.getElementById('deleteInitial').style.display = 'inline'; }
function confirmDelete() {
  if (selectedIdx == null) return;
  const email = submissions[selectedIdx].customer_email;
  submissions.splice(selectedIdx, 1);
  saveToStorage();
  if (isCloudMode()) cloudDelete(email);
  closeDetail();
  renderStats();
  renderTable();
  showToast('Submission deleted', 'info');
}

// ── Import/Export ──
function addSubmissions(data) {
  if (!Array.isArray(data)) data = [data];
  let added = 0, replaced = 0;
  data.forEach(d => {
    d._analyzed_at = d._analyzed_at || new Date().toISOString();
    d.customer_clarification = d.customer_clarification || '';
    const key = getKey(d);
    const existingIdx = submissions.findIndex(s => getKey(s) === key);
    if (existingIdx >= 0) {
      if (!d.customer_clarification && submissions[existingIdx].customer_clarification) d.customer_clarification = submissions[existingIdx].customer_clarification;
      submissions[existingIdx] = d;
      replaced++;
    } else { submissions.push(d); added++; }
  });
  saveToStorage();
  renderStats();
  renderTable();
  if (isCloudMode()) cloudSave(data);
  return { added, replaced };
}

function handleFileImport(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(ev) {
    try {
      const text = ev.target.result;
      const data = file.name.endsWith('.jsonl') ? text.trim().split('\n').filter(Boolean).map(l => JSON.parse(l)) : JSON.parse(text);
      const r = addSubmissions(data);
      showToast('Imported: ' + importMessage(r), 'success');
    } catch(err) { showToast('Import error: ' + err.message, 'error'); }
  };
  reader.readAsText(file);
  e.target.value = '';
}

function handlePasteImport() {
  const text = document.getElementById('pasteArea').value.trim();
  if (!text) return;
  try {
    let data;
    if (text.startsWith('[') || text.startsWith('{')) data = JSON.parse(text.startsWith('[') ? text : '[' + text + ']');
    else data = text.split('\n').filter(Boolean).map(l => JSON.parse(l));
    const r = addSubmissions(data);
    document.getElementById('pasteModal').classList.remove('active');
    document.getElementById('pasteArea').value = '';
    showToast('Imported: ' + importMessage(r), 'success');
  } catch(err) { showToast('Parse error: ' + err.message, 'error'); }
}

function exportJsonl() {
  const text = submissions.map(s => JSON.stringify(s)).join('\n');
  downloadFile(text, `armor-results-${new Date().toISOString().slice(0,10)}.jsonl`, 'application/jsonl');
  showToast('Exported ' + submissions.length + ' submissions as JSONL', 'success');
}

function exportJson() {
  downloadFile(JSON.stringify(submissions, null, 2), `armor-results-${new Date().toISOString().slice(0,10)}.json`, 'application/json');
  showToast('Exported ' + submissions.length + ' submissions as JSON', 'success');
}

function downloadFile(content, filename, type) {
  const blob = new Blob([content], { type });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
}

// ── Init ──
async function initApp() {
  renderStats();
  renderTable();
  const url = getSyncUrl();
  const autoSync = getAutoSync();
  document.getElementById('scriptUrlInput').value = url || DEFAULT_SYNC_URL;
  document.getElementById('autoSyncToggle').checked = autoSync;
  if (url) {
    updateSyncStatus('loading', 'Connecting...');
    const localClars = {};
    submissions.forEach(s => {
      const key = (s.customer_email || '').toLowerCase().trim();
      if (key) localClars[key] = s.customer_clarification || '';
    });
    const data = await cloudFetch();
    if (data) {
      submissions.forEach(s => {
        const key = (s.customer_email || '').toLowerCase().trim();
        if (key && key in localClars && localClars[key] !== s.customer_clarification) {
          s.customer_clarification = localClars[key];
        }
      });
      saveToStorage();
      renderStats();
      renderTable();
      if (autoSync) startAutoSync();
    }
  }
  updateSyncStatusDisplay();
}
</script>
</body>
</html>